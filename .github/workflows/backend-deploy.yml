name: üöÄ CI/CD Pipeline for Deployment

on:
  workflow_run:
    workflows: [ "shared-services-backend-deploy" ]
    types: [ completed ]

env:
  BACKEND_VERSION: v1.2
  DOCKER_IMAGE: project
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  build-images:
    name: üß± Build & Push Images
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [ backend ]

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üîë Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ‚öôÔ∏è Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: üê≥ Build & Push Docker Image
        if: ${{ matrix.service == 'backend' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployment/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}${{ matrix.service }}:${{ env.BACKEND_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest
    needs: build-images

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Define Deployment Environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "PROJECT_ROOT=/var/www/dev" >> $GITHUB_ENV
            echo "PROJECT_DIR=/var/www/dev/backend" >> $GITHUB_ENV
            echo "DEPLOY_FOLDER=deployment/dev" >> $GITHUB_ENV
            echo "BACKEND_DOMAIN=${{ secrets.DEV_BACKEND_DOMAIN }}" >> $GITHUB_ENV
          else
            echo "PROJECT_ROOT=/var/www/prod" >> $GITHUB_ENV
            echo "PROJECT_DIR=/var/www/prod/backend" >> $GITHUB_ENV
            echo "DEPLOY_FOLDER=deployment/prod" >> $GITHUB_ENV
            echo "BACKEND_DOMAIN=${{ secrets.BACKEND_DOMAIN }}" >> $GITHUB_ENV
          fi

      - name: üßæ Generate .env
        run: |
          cat <<EOF > .env
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          API_ID=${{ secrets.API_ID }}
          API_HASH=${{ secrets.API_HASH }}
          DJANGO_SECRET_KEY=${{ secrets.SECRET_KEY }}
          DJANGO_DEBUG=${{ secrets.DJANGO_DEBUG }}
          DATABASE_NAME=${{ secrets.DATABASE_NAME }}
          DATABASE_USER=postgres
          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
          BOT_TOKEN=${{ secrets.BOT_TOKEN }}
          USE_WEBHOOK=${{ secrets.USE_WEBHOOK }}
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          BOT_DOMAIN=${{ secrets.BOT_DOMAIN }}
          DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
          DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          BACKEND_VERSION=${{ env.BACKEND_VERSION }}
          BACKEND_IMAGE=${{ secrets.DOCKER_USERNAME }}/monitoring-backend:${{ env.BACKEND_VERSION }}
          USERBOT_IMAGE=${{ secrets.DOCKER_USERNAME }}/monitoring-userbot:${{ env.BACKEND_VERSION }}
          TELEGRAM_CHAT_IDS=${{ secrets.TELEGRAM_CHAT_IDS }}
          TELEGRAM_CHAT_ID=6990890693
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          BACKEND_DOMAIN=${{ env.BACKEND_DOMAIN }}
          PROMETHEUS_DOMAIN=${{ secrets.PROMETHEUS_DOMAIN }}
          GRAFANA_DOMAIN=${{ secrets.GRAFANA_DOMAIN }}
          USERBOT_DOMAIN=${{ secrets.USERBOT_DOMAIN }}
          USE_S3_STORAGE=${{ secrets.USE_S3_STORAGE }}
          AWS_S3_ENDPOINT_URL=${{ secrets.AWS_S3_ENDPOINT_URL }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME }}
          AWS_S3_USE_SSL=${{ secrets.AWS_S3_USE_SSL }}
          EOF

      - name: üîê Setup SSH Access
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üìÅ Prepare Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} <<'SSH'
            mkdir -p $PROJECT_ROOT/{static,media}
            mkdir -p $PROJECT_DIR/{grafana/{dashboards,provisioning/{datasources,dashboards}},prometheus}
          SSH

      - name: üì§ Upload & Deploy
        run: |
          scp -o StrictHostKeyChecking=no -r \
            ${{ env.DEPLOY_FOLDER }}/* .env deployment/deploy.sh deployment/nginx.conf \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$PROJECT_DIR/
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            chmod +x $PROJECT_DIR/deploy.sh && cd $PROJECT_DIR && ./deploy.sh
          "

      - name: üßπ Docker Cleanup
        run: ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "docker image prune -af && docker container prune -f"

      - name: ‚úÖ Telegram Notification - Success
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_IDS }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          message: |
            ‚úÖ <b>Deployment Successful</b>
            <b>Branch:</b> ${{ github.ref }}
            <b>Commit:</b> ${{ github.sha }}
            <b>Committer:</b> ${{ github.actor }}
            <b>Domain:</b> ${{ env.BACKEND_DOMAIN }}
            <b>Backend Version:</b> <code>${{ env.BACKEND_VERSION }}</code>
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Logs</a>

      - name: ‚ùå Telegram Notification - Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_IDS }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          message: |
            ‚ùå <b>Deployment Failed</b>
            <b>Branch:</b> ${{ github.ref }}
            <b>Commit:</b> ${{ github.sha }}
            <b>Committer:</b> ${{ github.actor }}
            <b>Backend Version:</b> <code>${{ env.BACKEND_VERSION }}</code>
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Logs</a>
